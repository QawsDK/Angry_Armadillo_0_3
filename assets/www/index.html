<!DOCTYPE html>
	<head>
		<meta charset="utf-8" />
		<title>Cykelruteplanlægger v.0.1 alpha</title>
		<link rel="stylesheet" type="text/css" href="css/dx.common.css" />
		<link rel="stylesheet" type="text/css" href="css/dx.ios.default.css" />
		<link rel="stylesheet" type="text/css" href="css/dx.android.holo-dark.css" />
		<link rel="stylesheet" type="text/css" href="css/dx.desktop.default.css" />
		<link rel="stylesheet" type="text/css" href="css/dx.win8.black.small.css" />
		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="js/knockout-2.2.1.js"></script>
		<script type="text/javascript" src="js/globalize.min.js"></script>
		<script type="text/javascript" src="js/dx.phonejs.js"></script>
		<script src="js/leaflet.js"></script>
		<script scr="cordova.js"></script>
		<link rel="stylesheet" href="css/leaflet.css" />
		<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=true"></script>
		<script src="js/L.Control.Locate.js"></script>
		<link rel="stylesheet" href="css/L.Control.Locate.css">
		<script src="js/google.js"></script>
		<script type="text/javascript">
			
			window.AppNamespace = {};
			$(function () {
				AppNamespace.app = new DevExpress.framework.html.HtmlApplication({
					namespace: AppNamespace,
					defaultLayout: "default"
				});
				AppNamespace.app.router.register(":view/:name", { view: "home", name: '' });
				AppNamespace.app.navigate();
			});
			
			//HOMEPAGE
			AppNamespace.home = function() {
				var viewModel = {
					message: 'Vælg din rute',
					start: ko.observable(''),
					start_pos: '',
					end: ko.observable(''),
					end_pos: '',
					direction: ko.observable(''),
					from_suggetions: ko.observableArray(),
					to_suggetions: ko.observableArray(),
					coordinates: ko.observableArray(),
					
					address: function(){
					
						//var a = document.getElementById('address').firstChild.value;
						var maxantal = 20;
						//if(a.length >= 3){
						if(this.end() == ''){
							var a = this.start();
						}
						else{
							var a = this.end();
						}
						
						
						if(a.length > 3){
						$.ajax({
						  type: "GET",
						  url: "http://webapi.aws.dk/adresser.json?q="+a+"&maxantal="+maxantal,
						  dataType: "jsonp"
						})
						  .done(function(data) {
							if(viewModel.direction() == 'from'){
								viewModel.from_suggetions([]);
							}
							else if(viewModel.direction() == 'to'){
								viewModel.to_suggetions([]);
							}
							viewModel.coordinates([]);
							//console.log(data); //skriver dataen i konsollen, ikke nødvendigt, kun til debugging
							$(data).each(function(i){
							if(viewModel.direction() == 'from'){
								viewModel.from_suggetions.push(data[i].vejnavn.navn +  ((data[i].husnr.length === 0) ? '' : ' ' + data[i].husnr) +  ' ' + data[i].postnummer.navn);
								
								viewModel.coordinates.push(data[i].vejnavn.navn +  ((data[i].husnr.length === 0) ? '' : ' ' + data[i].husnr) +  ' ' + data[i].postnummer.navn);
								viewModel.coordinates.push(data[i].wgs84koordinat.bredde + ' ' + data[i].wgs84koordinat.længde);
								
								console.log(viewModel.coordinates());
							}
							else{
								viewModel.to_suggetions.push(data[i].vejnavn.navn +  ((data[i].husnr.length === 0) ? '' : ' ' + data[i].husnr) +  ' ' + data[i].postnummer.navn);
								
								viewModel.coordinates.push(data[i].vejnavn.navn +  ((data[i].husnr.length === 0) ? '' : ' ' + data[i].husnr) +  ' ' + data[i].postnummer.navn);
								viewModel.coordinates.push(data[i].wgs84koordinat.bredde + ' ' + data[i].wgs84koordinat.længde);
								console.log(viewModel.coordinates());
							}
							});
						  });
						}
						else if(a.length < 3){
							viewModel.from_suggetions([]);
							viewModel.to_suggetions([]);
							viewModel.coordinates([]);
						}
						
					},
					
					selectStart: function(e){
						console.log(e.itemData);
						viewModel.start(e.itemData);
						viewModel.start_pos = viewModel.coordinates()[viewModel.coordinates().indexOf(e.itemData) + 1];
						viewModel.from_suggetions([]);
					},
					
					selectEnd: function(e){
					console.log(e.itemData);
						viewModel.end(e.itemData);
						viewModel.end_pos = viewModel.coordinates()[viewModel.coordinates().indexOf(e.itemData) + 1];
						viewModel.to_suggetions([]);
					},
					
					directionFrom: function(){
						viewModel.direction('from');
					},
					
					directionTo: function(){
						viewModel.direction('to');
					},
					
					showRoute: function(){
						document.location.href = 'http://62.242.40.24/gmltest/index.php?a='+viewModel.start_pos+'&b='+viewModel.end_pos;
					},
					
					kort: function() {
						AppNamespace.app.navigate("mappage");
					}
					
				};
				
				return viewModel;
				
			};
			
			//MAPPAGE
			AppNamespace.mappage = function() {
				var viewModel = {
					mapOne: ko.observable({
						lat: ko.observable('55.39955'),
						lng:ko.observable('10.389848')
				})	
			};
			
			ko.bindingHandlers.map = {
				init: function (element, valueAccessor, allBindingsAccessor, viewModel) {
					var mapObj = ko.utils.unwrapObservable(valueAccessor());
					
					var map = L.map('map-canvas',{maxZoom: 17, maximumAge: 1000, zoomControl: false}).setView([ko.utils.unwrapObservable(mapObj.lat), ko.utils.unwrapObservable(mapObj.lng)], 15);
					var osmUrl = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
						osmAttribution = '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>';
					var osm = L.tileLayer(osmUrl, {attribution: osmAttribution});
					var osm = L.tileLayer(osmUrl, {attribution: osmAttribution}).addTo(map);
					
					//Load Basemaps
					var mapquestUrl = 'http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png',
					mapquestAttribution = '<p>© OpenStreetMap, Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"></p>',
					subDomains = ['otile1','otile2','otile3','otile4'];
					var mapquest = L.tileLayer(mapquestUrl, {attribution: mapquestAttribution, subdomains: subDomains});
					
					var ghyp = new L.Google();	
					
					var baseLayers = {
						"OpenStreetMap": osm,
						"MapQuestOpen": mapquest,
						"Google Hybrid": ghyp
					};

					map.removeLayer(mapquest);
					map.removeLayer(ghyp);
					L.control.layers(baseLayers).addTo(map);
					L.control.zoom({position: 'bottomleft'}).addTo(map);
					L.control.locate({follow: true, stopFollowingOnDrag: false, setView: true, maximumAge: 1000, position: 'bottomleft', locateOptions:{watch: true, enableHighAccuracy: true}}).addTo(map);
					L.Util.requestAnimFrame(map.invalidateSize, map, false, map._container);
					
					
					
				}
			};
				return viewModel;
			};
		</script>
	</head>
<body>
	<div data-options="dxLayout : { name: 'default' } " style="height: 100%">
		<div data-bind="dxToolbar: { items: [ { text: 'Le App', align: 'center' } ] }"></div>
		<div data-options="dxContentPlaceholder : { name: 'content', transition: 'slide' } " ></div>
	</div>
	<div data-options="dxView : { name: 'home'}" style="height: 100%">
		<h1 data-bind="text: message"></h1>
		Fra: <div data-bind="dxTextBox: { value: start, valueUpdateEvent: 'keyup', keyUpAction: address, focusInAction: directionFrom}" style="width: 200px" id="fra"></div>

		<div data-bind="dxList:{dataSource: from_suggetions, itemClickAction: selectStart, noDataText: ''}" style="height: 100%"></div>

		Til: <div data-bind="dxTextBox: { value: end, valueUpdateEvent: 'keyup', keyUpAction: address, focusInAction: directionTo}" style="width: 200px" id="til"></div>
		<div data-bind="dxList:{dataSource: to_suggetions, itemClickAction: selectEnd, noDataText: ''}">
		</div>
		<!--
		<br><button onclick="showRoute();">Beregn rute</button>
		-->
		<button data-bind="dxButton:{text: 'Beregn rute', clickAction: showRoute}"></button>
	</div>
	<div data-options="dxView : { name: 'mappage'} " >
		<div id="map-canvas" data-bind="style:{width:'300px', height:'300px'},map:mapOne"></div>
	</div>
</body>
</html>